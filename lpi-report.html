<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LPI Report - PT. Prima Jaya Persada Nusantara</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .upload-area {
      border: 2px dashed #6fd6ff;
      border-radius: 14px;
      padding: 30px;
      text-align: center;
      background-color: #22335a;
      transition: all 0.3s ease;
      cursor: pointer;
      color: #e0e7ff;
      font-weight: 600;
    }
    .upload-area:hover {
      border-color: #4f8cff;
      background-color: #2a406b;
      color: #fff;
    }
    .upload-area.dragover {
      border-color: #6fffa3;
      background-color: #1e2a47;
      color: #fff;
    }
    .preview-image {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
      margin: 10px;
      border: 2px solid #4f8cff;
      background: #22335a;
    }
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10,22,51,0.85);
      z-index: 9999;
    }
    .loading-spinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #6fd6ff;
      text-align: center;
    }

    /* Card and form contrast improvements */
    .card {
      background: rgba(34, 51, 90, 0.98) !important;
      border: 1.5px solid #6fd6ff !important;
      box-shadow: 0 8px 36px 0 #0a1633cc;
    }
    .card-header {
      background: linear-gradient(90deg, #22335a 0%, #2b4a7a 100%) !important;
      color: #fff !important;
      border-bottom: 1.5px solid #6fd6ff !important;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 2px #0a1633cc;
    }
    .form-label, .form-check-label {
      color: #f8fafc !important;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 2px #0a1633cc;
    }
    .form-control, .form-select {
      background: #1a2540 !important;
      color: #e0e7ff !important;
      border: 1.5px solid #4f8cff !important;
      font-weight: 500;
      box-shadow: 0 2px 8px 0 #0a163355;
    }
    .form-control:focus, .form-select:focus {
      background: #22335a !important;
      color: #fff !important;
      border-color: #6fd6ff !important;
      box-shadow: 0 0 0 2px #6fd6ff55;
    }
    .form-control::placeholder {
      color: #e0e7ff !important;
      opacity: 1;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    .form-check-input:checked {
      background-color: #4f8cff !important;
      border-color: #6fd6ff !important;
      box-shadow: 0 0 0 2px #6fd6ff55;
    }
    .form-check-input {
      background: #1a2540 !important;
      border: 1.5px solid #4f8cff !important;
    }
    .form-check-label.text-danger {
      color: #ff4d6d !important;
      font-weight: 800;
      text-shadow: 0 1px 2px #0a1633cc;
    }
    .form-check-label.text-success {
      color: #6fffa3 !important;
      font-weight: 800;
      text-shadow: 0 1px 2px #0a1633cc;
    }
    .btn-gradient-primary {
      background: linear-gradient(90deg, #4f8cff 0%, #6fd6ff 100%) !important;
      color: #fff !important;
      font-weight: 700;
      border: none !important;
      box-shadow: 0 2px 8px 0 #0a163355;
    }
    .btn-gradient-primary:hover, .btn-gradient-primary:focus {
      background: linear-gradient(90deg, #6fd6ff 0%, #4f8cff 100%) !important;
      color: #fff !important;
      box-shadow: 0 4px 16px 0 #6fd6ff55;
    }
    .btn-outline-secondary {
      color: #e0e7ff !important;
      border-color: #6fd6ff !important;
      background: transparent !important;
      font-weight: 600;
    }
    .btn-outline-secondary:hover, .btn-outline-secondary:focus {
      background: #22335a !important;
      color: #6fd6ff !important;
      border-color: #4f8cff !important;
    }
    .badge {
      background: linear-gradient(90deg, #4f8cff 0%, #6fd6ff 100%) !important;
      color: #fff !important;
      font-weight: 800;
      font-size: 1rem;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px 0 #0a163355;
      text-shadow: 0 1px 2px #0a1633cc;
    }
    /* Placeholder text color for better contrast */
    ::placeholder {
      color: #e0e7ff !important;
      opacity: 1;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    /* Date input icon color fix for dark bg */
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
    }
    /* Alert contrast */
    .alert {
      background: #22335a !important;
      color: #fff !important;
      border: 1.5px solid #4f8cff !important;
      font-weight: 600;
      box-shadow: 0 2px 8px 0 #0a163355;
    }
    .alert-success {
      background: #22335a;
      color: #6fd6ff;
      border-color: #6fd6ff;
    }
    .alert-danger {
      background: #2a1e2e;
      color: #ff4d6d;
      border-color: #ff4d6d;
    }
    .alert-warning {
      background: #3a2e1e;
      color: #ffe066;
      border-color: #ffe066;
    }
    /* Scrollbar styling for dark mode */
    ::-webkit-scrollbar {
      width: 10px;
      background: #1a2540;
    }
    ::-webkit-scrollbar-thumb {
      background: #4f8cff;
      border-radius: 8px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #6fd6ff;
    }
  </style>
</head>
<body style="background: linear-gradient(120deg, #23395d 0%, #1e2a47 100%); min-height: 100vh; font-family: 'Segoe UI', 'Roboto', Arial, sans-serif; color: #eaf2ff;">
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="mt-3">
        <h5 class="fw-bold text-primary">Menyimpan ke Google Sheet...</h5>
        <p class="text-secondary">Mohon tunggu sebentar</p>
      </div>
    </div>
  </div>
  <div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="mb-2 fw-bold text-white" style="letter-spacing: 1px;">
          <i class="fas fa-clipboard-list text-info me-2"></i>LPI Report
        </h2>
        <p class="mb-0 fs-5" style="color:#e0e7ff;">
          <span class="fw-semibold">Sistem Pelaporan LPI</span>
          <span class="badge bg-gradient bg-primary bg-opacity-50 text-white ms-2 shadow-sm">Google Sheet Integration</span>
        </p>
      </div>
    </div>
    <div id="alertContainer"></div>
    <div class="card mb-4 shadow-lg border-0 rounded-4" style="background:rgba(30,42,71,0.97);">
      <div class="card-header bg-primary bg-opacity-10 border-0 rounded-top-4 d-flex align-items-center">
        <i class="fas fa-plus-circle me-2 text-primary fs-4"></i>
        <h5 class="mb-0 fw-semibold text-white flex-grow-1">Form LPI Report</h5>
      </div>
      <div class="card-body p-4">
        <form id="hazardReportForm">
          <div class="row g-4">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="reporterName" class="form-label fw-semibold text-secondary">
                  <i class="fas fa-lock me-1"></i>Site*
                </label>
                <input type="text" class="form-control bg-light border-0 rounded-3 shadow-sm" id="reporterName" value="TCMM" readonly required tabindex="-1" style="pointer-events: none; user-select: none;">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="dept" class="form-label fw-semibold text-secondary">
                  <i class="fas fa-lock me-1"></i>Dept
                </label>
                <input type="text" class="form-control bg-light border-0 rounded-3 shadow-sm" id="dept" value="SHE" readonly required tabindex="-1" style="pointer-events: none; user-select: none;">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="reportDate" class="form-label fw-semibold text-secondary">
                  <i class="fas fa-calendar me-1"></i>Tanggal Pelaporan *
                </label>
                <input type="date" class="form-control border-0 bg-light rounded-3 shadow-sm" id="reportDate" required>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="location" class="form-label fw-semibold text-secondary">
              <i class="fas fa-lightbulb me-1"></i>Rekomendasi / Action Plan *
            </label>
            <input type="text" class="form-control border-0 bg-light rounded-3 shadow-sm" id="location" placeholder="Contoh : Dilakukan coaching & counseling" required>
          </div>
          <div class="mb-3">
            <label for="hazardType" class="form-label fw-semibold text-secondary">
              <i class="fas fa-exclamation-circle me-1"></i>Kategori Insiden *
            </label>
            <select class="form-select border-0 bg-light rounded-3 shadow-sm" id="hazardType" required>
              <option value="">Pilih Kategori Insiden</option>
              <option value="property_damage">Property Damage</option>
              <option value="injury_incident">Injury Incident</option>
              <option value="environment">Environment</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="priority" class="form-label fw-semibold text-secondary">
              <i class="fas fa-flag me-1"></i>Status *
            </label>
            <div class="row">
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="priority" id="priorityHigh" value="Open" required>
                  <label class="form-check-label text-danger fw-semibold" for="priorityHigh">
                    <i class="fas fa-door-open me-1"></i>Open
                  </label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="priority" id="priorityMedium" value="Close" required>
                  <label class="form-check-label text-success fw-semibold" for="priorityMedium">
                    <i class="fas fa-door-closed me-1"></i>Close
                  </label>
                </div>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold text-secondary">
              <i class="fas fa-camera me-1"></i>Upload Foto Bukti
            </label>
            <div class="upload-area shadow-sm" id="uploadArea">
              <i class="fas fa-file-upload fa-3x text-primary mb-3"></i>
              <h6 class="fw-semibold">Klik untuk memilih file</h6>
              <p class="text-muted">Format: JPG, PNG, GIF, PDF (Max 5MB)</p>
              <input type="file" id="fileInput" multiple accept="image/*,application/pdf" style="display: none;">
            </div>
            <div id="imagePreview" class="mt-3"></div>
          </div>
          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <button type="button" class="btn btn-outline-secondary me-md-2 px-4 py-2 fw-semibold shadow-sm" onclick="resetForm()">
              <i class="fas fa-undo me-2"></i>Reset
            </button>
            <button type="submit" class="btn btn-gradient-primary px-4 py-2 fw-semibold shadow-sm" style="background: linear-gradient(90deg, #4f8cff 0%, #6fd6ff 100%); color: #fff; border: none;">
              <i class="fas fa-paper-plane me-2"></i>Kirim ke Google Sheet
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Google Apps Script Web App URL - UPDATE SETELAH DEPLOY
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzw_nQicy_hVaGwWCRETq3Eu7Mtg_Opnqsh9Qq5SI28pMYHf3IIAd94v8GS_oGolm9V2w/exec';
    // Set default date to today
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('reportDate').valueAsDate = new Date();
    });
    // File upload handling
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const imagePreview = document.getElementById('imagePreview');
    let selectedFiles = [];
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });
    function handleFiles(files) {
      let fileArray = Array.from(files).filter(file => {
        if (file.size > 5 * 1024 * 1024) {
          showAlert('warning', `File ${file.name} terlalu besar (max 5MB)`);
          return false;
        }
        // Terima gambar dan PDF
        return file.type.startsWith('image/') || file.type === 'application/pdf';
      });
      if (selectedFiles.length + fileArray.length > 2) {
        showAlert('warning', 'Maksimal hanya boleh upload 2 file (foto/PDF).');
        fileArray = fileArray.slice(0, 2 - selectedFiles.length);
      }
      selectedFiles = selectedFiles.concat(fileArray).slice(0, 2);
      displayImagePreviews();
    }
    function displayImagePreviews() {
      imagePreview.innerHTML = '';
      selectedFiles.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'd-inline-block position-relative me-2 mb-2';
        if (file.type === 'application/pdf') {
          div.innerHTML = `
            <div class="d-flex align-items-center justify-content-center" style="height: 60px; width: 60px; background: #1a2540; border-radius: 8px; border: 2px solid #4f8cff;">
              <i class="fas fa-file-pdf fa-2x text-danger"></i>
            </div>
            <div class="text-center mt-1" style="max-width:80px; color:#e0e7ff; font-size:0.85em; word-break:break-all;">${file.name}</div>
            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" onclick="removeImage(${index})" style="transform: translate(50%, -50%);">
              <i class="fas fa-times"></i>
            </button>
          `;
        } else {
          const reader = new FileReader();
          reader.onload = (e) => {
            div.innerHTML = `
              <img src="${e.target.result}" class="preview-image" alt="Preview">
              <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0" onclick="removeImage(${index})" style="transform: translate(50%, -50%);">
                <i class="fas fa-times"></i>
              </button>
            `;
          };
          reader.readAsDataURL(file);
        }
        imagePreview.appendChild(div);
      });
    }
    function removeImage(index) {
      selectedFiles.splice(index, 1);
      displayImagePreviews();
    }
    document.getElementById('hazardReportForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      document.getElementById('uploadSuccessAlert')?.classList.add('d-none');
      if (SCRIPT_URL.includes('YOUR_SCRIPT_ID') || SCRIPT_URL === 'PASTE_YOUR_DEPLOYED_WEBAPP_URL_HERE') {
        showAlert('warning', 'Google Apps Script belum dikonfigurasi. Silakan setup terlebih dahulu.');
        return;
      }
      document.getElementById('loadingOverlay').style.display = 'block';
      try {
        const formData = new FormData();
        // Tambahkan timestamp lokal (ISO string) ke kolom A
        formData.append('timestamp', new Date().toISOString());
        formData.append('reporterName', 'TCMM');
        formData.append('dept','SHE'); // Tambahkan dept
        formData.append('reportDate', document.getElementById('reportDate').value);
        formData.append('location', document.getElementById('location').value);
        formData.append('hazardType', document.getElementById('hazardType').value);
        formData.append('priority', document.querySelector('input[name="priority"]:checked').value);
        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          const base64 = await fileToBase64(file);
          formData.append(`file${i}`, base64);
          formData.append(`fileName${i}`, file.name);
        }
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData
        });
        const result = await response.text();
        if (result.includes('success')) {
          showAlert('success', 'Laporan berhasil dikirim ke Google Sheet!');
          resetForm();
        } else {
          throw new Error(result);
        }
      } catch (error) {
        showAlert('danger', 'Gagal mengirim laporan: ' + error.message);
      } finally {
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    });
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
      });
    }
    function resetForm() {
      document.getElementById('hazardReportForm').reset();
      document.getElementById('reportDate').valueAsDate = new Date();
      selectedFiles = [];
      imagePreview.innerHTML = '';
    }
    function showAlert(type, message) {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show`;
      alert.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'times-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.getElementById('alertContainer').appendChild(alert);
      setTimeout(() => {
        if (alert.parentNode) {
          alert.remove();
        }
      }, 5000);
    }
  </script>
</body>
</html>
